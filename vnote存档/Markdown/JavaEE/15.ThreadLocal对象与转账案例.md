# 转账与ThreadLocal对象  
## 一、转账初级  
### 1.1 案例分析 
![](_v_images/20190508231404126_27364.png =758x)  
### 1.2 环境搭建  
1. 先导入包:操作数据库的mysql驱动包、c3p0连接池包、DBUtils包  
2. 按照三层架构建包  
 ![](_v_images/20190508231824306_8098.png)  
3. 建一个转账的简单表单页面  
![](_v_images/20190508231923843_26248.png =816x)  
### 1.3 代码详解  
#### 1.3.1 web层  
![](_v_images/20190508232519811_15052.png =790x)  
#### 1.3.2 service层  
![](_v_images/20190508233143167_6251.png =634x)  
注意，为什么要在finally那里提交事务，是<font color=red>为了确保事务能够关闭</font>。  
#### 1.3.3 dao层  
本层很简单  
![](_v_images/20190508233225735_11750.png =880x)  
### 1.4 结果  
略，没有遗漏同一个connection这种问题，事务控制也正确。再次提醒对DBUtils的记忆，本版本还是很简单。通过c3p0连接池，结合DBUtils，执行sql语句。  
![](_v_images/20190508233757131_17598.png =656x)  
## 二、 转账高级与ThreadLocal对象  
### 2.1 不足之处  
1. 为什么在service层中和dao层中都用到了一个Connection，这种跨层的数据不是污染了MVC架构吗？  
2. 我们希望三层能够共享数据，如果需要共享数据的话，可以实现不通过传参的方法共享数据。
3. 这明显是单线程程序，为啥不考虑在线程中同步更新一个数据。  
### 2.2 ThreadLocal对象  
ThreadLocal一般称为<font color=red>**线程本地变量**</font>，它是一种<font color=red>特殊的线程绑定机制</font>，将变量与线程绑定在一起，<font color=red>为每一个线程维护一个独立的变量副本</font>。通过ThreadLocal可以将对象的可见范围限制在同一个线程内。  ThreadLocal从本质上讲，无非是提供了一个“线程级”的变量作用域，它是一种<font color=red>线程封闭（每个线程独享变量）技术</font>，更直白点讲，ThreadLocal可以理解为将对象的作用范围限制在一个线程上下文中，使得<font color=red>变量的作用域为“线程级”</font>。
#### 2.2.1 重新封装自己的DataSourceUtils包  
![](_v_images/20190509000642115_4315.png =823x)  
![](_v_images/20190509000911308_4568.png =831x)  
最关键的代码是`getCurrentConnection()`  
![](_v_images/20190509001202450_16020.png =780x)  
#### 2.2.2 重写service层  
![](_v_images/20190509001539569_18997.png =743x)  
#### 2.2.3 重写dao层  
![](_v_images/20190509001754588_20228.png =755x)  

